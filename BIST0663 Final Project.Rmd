---
title: "BISST0663_Final_Project"
author: "Jueshen Hou  Zimeng Ren"
date: "2024-10-09"
output: pdf_document
---

```{r,eval=TRUE}
##This chunk is only needed when running on Jason's laptop.If it is on Jason's device change eval=TRUE
options("install.lock"=FALSE)
```

```{r install package in case you do not have it, eval=FALSE, include=FALSE}
##These packages are needed for later code chunks,if you do not have the following packages installed, please run this chunk to ensure all packages needed are installed.
install.packages(c("ggplot2","broom","gridExtra","class","tidyverse","leaps","corrplot","RColorBrewer","glmnet","xtable","randomForest","pROC","devtools","UpSetR","naniar","report","rpart","rattle","rpart.plot"))
install.packages("randomForest")
```

```{r}
#This is a test2222
```


```{r load packages, include=FALSE}
##Here we load the packages needed and install a package that is not on CRAN
library(ggplot2)
library(broom)
library(gridExtra)
library(class)
library(tidyverse)
library(gridExtra)
library(leaps)
library(corrplot)
library(RColorBrewer)
library(glmnet)
library(xtable)
library(randomForest)
library(tree)
library(pROC)
#library(smotefamily)
library(devtools)
library(UpSetR)
library(naniar)
library(report)
library(rpart)
library(rattle)
library(rpart.plot)
library(DataExplorer)
library(BART)
library(gbm)
```

### Load Datas
```{r}
ALZH<-read.csv("https://raw.githubusercontent.com/jasonh0509/StatsLearningFinal/refs/heads/main/alzheimers_disease_data.csv")
```

### Take a Look

```{r}
glimpse(ALZH)
```

```{r}
ALZH_noID<-ALZH[,-1]
```


```{r}
na_plot_ALZH<-vis_miss(ALZH_noID);na_plot_ALZH

```

```{r}
colSums(is.na(ALZH_noID))
```

```{r changing data types}
ALZH_noID$Diagnosis<-as.factor(ALZH_noID$Diagnosis)
ALZH_noID <- ALZH_noID %>%
  mutate(across(c(Gender, Ethnicity,EducationLevel,Smoking,FamilyHistoryAlzheimers,CardiovascularDisease,Diabetes,Depression,HeadInjury,Hypertension,MemoryComplaints,BehavioralProblems,Confusion,Disorientation,PersonalityChanges,DifficultyCompletingTasks,Forgetfulness), as.factor))
```

```{r}
alzh_classes<-ggplot(data = ALZH_noID, mapping = aes(x=Diagnosis,fill=Diagnosis))+
  geom_bar()+
  xlab("Diagnosis Status")+
  ggtitle("Figure x.x Classes of Alzheimer's Disease")
  
alzh_classes
```


```{r}
ggplot(data = ALZH_noID, mapping = aes(x=Diagnosis,fill=Diagnosis))+
  geom_bar()+
  xlab("Diagnosis Status")+
  ggtitle("Classes of Alzheimer's Disease After SMOTE")
  
```

### logistic


```{r}
ALZH_for_explore<-ALZH_noID%>%dplyr::select(-DoctorInCharge)
n <-nrow(ALZH_for_explore);n

set.seed(114514)
draw<-sample(1:n,size = 1934)

train <-ALZH_for_explore[draw,]
train_x<-train%>%dplyr::select(-Diagnosis)
train_y<-train%>%dplyr::select(Diagnosis)

test <- ALZH_for_explore[-draw,]
test_x<-test%>%dplyr::select(-Diagnosis)
test_y <-test$Diagnosis


x <-model.matrix(Diagnosis~.,data=ALZH_for_explore)
y <- ALZH_noID$Diagnosis
```

```{r}
ALZH_logistic <-glm(Diagnosis~.,data=train,family = binomial())
summary(ALZH_logistic)
```

```{r eval=FALSE, include=FALSE}
###subject to fix
pred_test<-predict(ALZH_logistic,type='response',newdata = test)
glm.pred <- ifelse(pred_test > 0.5, 1, 0)
table(glm.pred, test_y)
```


### lasso

```{r}
##subject to fix
library(glmnet)
grid <- 10^seq(10,-2, length = 100)
lasso.mod <-glmnet(train_x, train_y, alpha = 1,lambda = grid)
plot(lasso.mod)
summary(lasso.mod)
cv.out <-cv.glmnet(x, y, alpha = 1,family="binomial")
plot(cv.out)
best_lambda <- cv.out$lambda.min;best_lambda
```


```{r}
train_y<-as.matrix(train_y)
lasso.final<-glmnet(train_x,train_y,alpha = 1,lambda = best_lambda)
lasso.pred <- predict(lasso.final, s = best_lambda, newx = as.matrix(test_x))
lasso.pred.class<-ifelse(lasso.pred > 0.5,1,0)
table(prediction=lasso.pred.class,actual=test_y)
```

```{r}
Recall.lasso<-sum(lasso.pred.class == 1 & test_y == 1)/sum(test_y == 1);Recall.lasso
```

Lasso only reaches 0.03 Recall.

```{r}
ALZH_leanning<-ALZH_noID%>%dplyr::select(-DoctorInCharge)
bestsubset <- regsubsets(Diagnosis~., data = ALZH_leanning)
bestsubsum<-summary(bestsubset)
bestsubsum
which.min(bestsubsum$cp)
which.min(bestsubsum$bic)
which.min(bestsubsum$adjr2)
```

```{r}
knitr::kable(coef(bestsubset,8))
bestSubset_vars <- names(coef(bestsubset, 8))[-1]
bestSubset_vars
bestSubset_STR<-paste(bestSubset_vars,collapse = ",")
```




```{r}
glimpse(ALZH_noID)
```

```{r}
ALZH_IntOnly<-ALZH_noID[,sapply(ALZH_noID,is.integer)]
ALZH_double<-ALZH_noID[,sapply(ALZH_noID,is.double)]
ALZH_NumOnly<-cbind(ALZH_IntOnly,ALZH_double)
ALZH_fct<-ALZH_noID[,sapply(ALZH_noID,is.factor)]

```

```{r}
glimpse(ALZH_NumOnly)
```





```{r}
plot_intro(ALZH_noID)
```






```{r positive only set}
alzh_pos<-subset(ALZH_noID,Diagnosis==1)

alzh_gender<-alzh_pos%>%
  group_by(Gender)%>%
  summarise(n = n()) %>%
  ggplot(aes(x = Gender, y = n,fill=Gender))+
  geom_col()+
  labs(y="Count of Alzheimer's ")
alzh_gender+ggtitle("Alzheimer's  Across Gender")

alzh_diab<-alzh_pos%>%
  group_by(Diabetes)%>%
  summarise(n = n()) %>%
  ggplot(aes(x = Diabetes, y = n,fill=Diabetes))+
  geom_col()+
  labs(y="Count of Alzheimer's ")
alzh_diab+ggtitle("Alzheimer's in Diabetics")

```

```{r}
alzh_smoke<-alzh_pos%>%
  group_by(Smoking)%>%
  summarise(n = n()) %>%
  ggplot(aes(x = Smoking, y = n,fill=Smoking))+
  geom_col()+
  labs(y="Count of Alzheimer's ")
alzh_smoke+ggtitle("Figure x.x Alzheimer's in Cigarette Users")

```

```{r}
alzh_edu<-alzh_pos%>%
  group_by(EducationLevel)%>%
  summarise(n = n()) %>%
  ggplot(aes(x = EducationLevel, y = n,fill=EducationLevel))+
  geom_col()+
  labs(y="Count of Alzheimer's ")
alzh_edu+ggtitle("Alzheimer's Disease and Education")

```

```{r}
alzh_ethnicity<-alzh_pos%>%
  group_by(Ethnicity)%>%
  summarise(n = n()) %>%
  ggplot(aes(x = Ethnicity, y = n,fill=Ethnicity))+
  geom_col()+
  labs(y="Count of Alzheimer's ")
alzh_edu+ggtitle("Alzheimer's and Ethnicity")

```

```{r}
age_alz<-ggplot(data=ALZH_noID,aes(x=Age,y=CholesterolTotal,color=Diagnosis))+geom_point()
age_alz+ggtitle("Figure 2.9 Age vs BMI Respect to Alzh")

```

```{r}
plot_correlation(ALZH_NumOnly)
```


```{r}
ALZH_noID_noCholest<-
  ALZH_noID%>%
  dplyr::select(-CholesterolTotal,-CholesterolHDL,-CholesterolLDL,-CholesterolTriglycerides)
```

```{r}
alzh_secondKNN<-ALZH_noID%>%
dplyr::select(Diagnosis,Age,BMI,AlcoholConsumption,DietQuality,SleepQuality,ADL)
#dplyr::select()
```

### KNN

```{r}
set.seed(12345)
k_list<-seq(1,20,by=1)
Perf.Metric.knn<-data.frame(k=k_list,Recall=rep(0,length(k_list)),Precision=rep(0,length(k_list)),F1_Score=rep(0,length(k_list)),
Accuracy=rep(0,length(k_list)))
for (k in k_list){
  alzh_knn<-knn(train = alzh_secondKNN[draw,]%>%select(-Diagnosis),
  test = alzh_secondKNN[-draw,]%>%select(-Diagnosis),cl = alzh_secondKNN[draw,]$Diagnosis,k=k)
  Perf.Metric.knn[k,2]<-sum(alzh_knn == 1 & test_y == 1)/sum(test_y == 1)
  Perf.Metric.knn[k,3]<-sum(alzh_knn == 1 & test_y == 1)/sum(alzh_knn == 1)
  Perf.Metric.knn[k,4]<-2*Perf.Metric.knn[k,2]*Perf.Metric.knn[k,3]/(Perf.Metric.knn[k,2]+Perf.Metric.knn[k,3])
  Perf.Metric.knn[k,5]<-sum(alzh_knn == test_y)/length(test_y)
}

Perf.Metric.knn$k[which.max(Perf.Metric.knn$Recall)]
Perf.Metric.knn$Recall[which.max(Perf.Metric.knn$Recall)]
plot(Perf.Metric.knn$k,Perf.Metric.knn$F1_Score,type="l",xlab="k",ylab="Recall")
Perf.Metric.knn
```

```{r}
knn.final<-knn(train = train_x,test = test_x,cl = train_y,k=4)
table(knn.final,test_y)
```

```{r}
knitr::kable(table("Prediction" = storage_inner$YHat,"Actual" = alzh_knn$Diagnosis),caption = "Confusion Matrix of Predicting Stroke (10-fold Cross Validation with k=1)")
```



### BART (does not produce anything)

```{r}
#ALZH.bart <- ALZH_noID%>%select(-DoctorInCharge)
ALZH.bart <- ALZH_noID %>% select(where(is.numeric),Diagnosis)
ALZH.bart$Diagnosis<-as.numeric(as.character(ALZH.bart$Diagnosis))
```

```{r}
set.seed(114514)
x_bart <- ALZH.bart %>% select(-Diagnosis)
y_bart <- ALZH.bart$Diagnosis
x_train_bart <- x_bart[draw, ]
y_train_bart <- as.numeric(as.character(y_bart[draw]))

x_test <- x_bart[-draw, ]
y_test <- y_bart[-draw]
bart_alzh <- gbart(
  x.train = x_train_bart,
  y.train = y_train_bart,
  x.test = x_test,
  type = "pbart",
  k = 1,
  ndpost = 2000
)

pred_bart <- bart_alzh$yhat.test.mean
pred_bart_class <- ifelse(pred_bart > 0.5, 1, 0)
accuracy <- mean(pred_bart_class == y_test)
accuracy
```


### gbm

```{r}
set.seed(12345)
set.seed(12345)
ALZH.gbm.raw <- ALZH_noID %>% select(-DoctorInCharge) %>% mutate(Diagnosis = as.numeric(as.character(Diagnosis)))
train_indices <- sample(1:nrow(ALZH.gbm.raw), size = 0.9 * nrow(ALZH.gbm.raw))
ALZH.gbm <- ALZH.gbm.raw[train_indices, ]
boosting.try <- gbm(Diagnosis ~ ., data = ALZH.gbm[draw,], distribution = "bernoulli", n.trees = 5000, interaction.depth = 4, shrinkage = 0.01)

```

```{r}
yhat.gbm<-predict(boosting.try,newdata = ALZH.gbm[-draw,],n.trees = 5000,interaction.depth = 4,shrinkage = 0.01,type = "response")
pred_gbm_class <- ifelse(yhat.gbm > 0.5, 1, 0)
table(pred_gbm_class,ALZH.gbm[-draw,]$Diagnosis)
```

```{r}
set.seed(12345)
lambda_val <- seq(0.01, 0.1, by = 0.01)
result_container <- data.frame(Lambda = lambda_val, Recall = rep(0, length(lambda_val)))

for (i in 1:length(lambda_val)) {
 
  Boosting_alzh <- gbm(Diagnosis ~., data = ALZH.gbm[draw,], distribution = "bernoulli", n.trees = 2000, interaction.depth = 4, shrinkage = lambda_val[i])
  result_container$Recall[i] <-sum(predict(Boosting_alzh, newdata = ALZH.gbm[-draw,], n.trees = 2000, type = "response") > 0.5 & ALZH.gbm[-draw,]$Diagnosis == 1) / sum(ALZH.gbm[-draw,]$Diagnosis == 1)

}
plot(x=result_container$Lambda, y=result_container$Recall,xlab = "Lambda", ylab = "Recall", type = "l")
```


```{r}
set.seed(12345)
lambda_val <- seq(0.01, 0.1, by = 0.01)
result_container <- data.frame(Lambda = lambda_val, Recall = rep(0, length(lambda_val)))

for (i in 1:length(lambda_val)) {
 
  Boosting_alzh <- gbm(Diagnosis ~., data = ALZH.gbm[draw,], distribution = "bernoulli", n.trees = 2000, interaction.depth = 4, shrinkage = lambda_val[i])
  result_container$Recall[i] <-sum(predict(Boosting_alzh, newdata = ALZH.gbm[-draw,], n.trees = 2000, type = "response") > 0.5 & ALZH.gbm[-draw,]$Diagnosis == 1) / sum(ALZH.gbm[-draw,]$Diagnosis == 1)

}
plot(x=result_container$Lambda, y=result_container$Recall,xlab = "Lambda", ylab = "Recall", type = "l")
```


```{r}
set.seed(12345)
lambda_val <- seq(0.01, 0.1, by = 0.01)
ntree_val <- c(1000, 2000, 3000,4000,5000
)
result <- data.frame()

for (lambda in lambda_val) {
  cat("Iteration: ", lambda, "\n")
  for (ntree in ntree_val) {
    cat("Iteration: ", ntree, "\n")
    recall_values <- c()
    precision_values <- c()
    f1_values <- c()
    
    for (fold in 1:10) {
      infold <- which(fold == sample(rep(1:10, length.out = nrow(ALZH.gbm))))
      train_data <- ALZH.gbm[-infold, ]
      test_data <- ALZH.gbm[infold, ]
      
      Boosting_alzh <- gbm(Diagnosis ~ ., data = train_data, distribution = "bernoulli", n.trees = ntree, interaction.depth = 4, shrinkage = lambda)
      pred <- predict(Boosting_alzh, newdata = test_data, n.trees = ntree, type = "response")
      pred_class <- ifelse(pred > 0.5, 1, 0)
      
      tp <- sum(pred_class == 1 & test_data$Diagnosis == 1)
      fp <- sum(pred_class == 1 & test_data$Diagnosis == 0)
      fn <- sum(pred_class == 0 & test_data$Diagnosis == 1)
      
      recall <- tp / (tp + fn)
      precision <- tp / (tp + fp)
      f1_score <- 2 * (precision * recall) / (precision + recall)
      
      recall_values <- c(recall_values, recall)
      precision_values <- c(precision_values, precision)
      f1_values <- c(f1_values, f1_score)
    }
    
    result <- rbind(result, data.frame(Lambda = lambda, NTree = ntree, Recall = mean(recall_values), Precision = mean(precision_values), F1_Score = mean(f1_values)))
  }
}

best_result <- result[which.max(result$Recall), ]
best_result
plot(result$Lambda, result$F1_Score, xlab = "Lambda", ylab = "F1 Score", type = "l", col = "blue")
points(best_result$Lambda, best_result$F1_Score, col = "red", pch = 19)
```


```{r}
set.seed(12345)
boosting.azh.after10fold <- gbm(Diagnosis ~ ., data = ALZH.gbm[draw,], distribution = "bernoulli", n.trees = 1000, interaction.depth = 4, shrinkage = 0.01)
yhat.gbm.10fold<-predict(boosting.azh.after10fold,newdata = ALZH.gbm[-draw,],type = "response",n.trees = 1000,interaction.depth=4,shrinkage=0.01)
pred_gbm_class.10fold <- ifelse(yhat.gbm.10fold > 0.5, 1, 0)
table("Prediction" = pred_gbm_class.10fold, "Actual" = ALZH.gbm[-draw,]$Diagnosis)
```

### 10 fold cv gbm

```{r}
set.seed(12345)
lambda_val <- seq(0.01, 0.1, by = 0.01)
result_container <- data.frame(Lambda = lambda_val, Recall = rep(0, length(lambda_val)))

for (i in 1:length(lambda_val)) {
  recall_values <- c()
  
  for (fold in 1:10) {
    infold <- which(fold == sample(rep(1:10, length.out = nrow(ALZH.gbm))))
    train_data <- ALZH.gbm[-infold, ]
    test_data <- ALZH.gbm[infold, ]
    
    Boosting_alzh <- gbm(Diagnosis ~., data = train_data, distribution = "bernoulli", n.trees = 2000, interaction.depth = 4, shrinkage = lambda_val[i])
    recall <- sum(predict(Boosting_alzh, newdata = test_data, n.trees = 2000, type = "response") > 0.5 & test_data$Diagnosis == 1) / sum(test_data$Diagnosis == 1)
    recall_values <- c(recall_values, recall)
  }
  
  result_container$Recall[i] <- mean(recall_values)
}

plot(x = result_container$Lambda, y = result_container$Recall, xlab = "Lambda", ylab = "Recall", type = "l")
```

```{r}
set.seed(12345)
lambda_val <- seq(0.01, 0.1, by = 0.01)
result_container <- data.frame(Lambda = lambda_val, Recall = rep(0, length(lambda_val)), Precision = rep(0, length(lambda_val)), F1_Score = rep(0, length(lambda_val)))

for (i in 1:length(lambda_val)) {
  Boosting_alzh <- gbm(Diagnosis ~., data = ALZH.gbm[draw,], distribution = "bernoulli", n.trees = 2000, interaction.depth = 4, shrinkage = lambda_val[i])
  pred <- predict(Boosting_alzh, newdata = ALZH.gbm[-draw,], n.trees = 2000, type = "response")
  pred_class <- ifelse(pred > 0.5, 1, 0)
  
  tp <- sum(pred_class == 1 & ALZH.gbm[-draw,]$Diagnosis == 1)
  fp <- sum(pred_class == 1 & ALZH.gbm[-draw,]$Diagnosis == 0)
  fn <- sum(pred_class == 0 & ALZH.gbm[-draw,]$Diagnosis == 1)
  
  recall <- tp / (tp + fn)
  precision <- tp / (tp + fp)
  f1_score <- 2 * (precision * recall) / (precision + recall)
  
  result_container$Recall[i] <- recall
  result_container$Precision[i] <- precision
  result_container$F1_Score[i] <- f1_score
}

plot(x = result_container$Lambda, y = result_container$F1_Score, xlab = "Lambda", ylab = "F1 Score", type = "l")
```



```{r}
set.seed(12345)
Boosting_alzh.final<-gbm(Diagnosis~.,data=ALZH.gbm[draw,],distribution="bernoulli",n.trees=2000,interaction.depth=4,shrinkage=0.01)
yhat.boost.final<-predict(Boosting_alzh.final,newdata = ALZH.gbm[-draw,],n.trees = 2000,interaction.depth = 4,shrinkage = 0.01,type = "response")
pred_gbm_class_final <- ifelse(yhat.boost.final > 0.5, 1, 0)
table(pred_gbm_class_final,ALZH.gbm[-draw,]$Diagnosis)
```


### tune 2 at once 


```{r}
set.seed(12345)
lambda_val <- seq(0.01, 0.1, by = 0.01)
ntree.val<-c(1000,2000,3000,4000,5000)
result <- data.frame()
for (i in 1:length(lambda_val)) {
  #cat("Iteration: ", i, "\n")
  Boosting_alzh <- gbm(Diagnosis ~., data = ALZH.gbm[draw,], distribution = "bernoulli", n.trees = ntree.val, interaction.depth = 4, shrinkage = lambda_val[i])
  result_container$Recall[i] <-sum(predict(Boosting_alzh, newdata = ALZH.gbm[-draw,], n.trees = 2000, type = "response") > 0.5 & ALZH.gbm[-draw,]$Diagnosis == 1) / sum(ALZH.gbm[-draw,]$Diagnosis == 1)
  #yhat.boost.inLoop <- predict(Boosting_Hitter, newdata = Hitters.Test, n.trees = 1000)
  #result_container$Test.MSE[i] <- mean((yhat.boost.inLoop - Hitters.Test$Salary)^2)
}
set.seed(12345)
lambda_val <- seq(0.01, 0.1, by = 0.01)
ntree_val <- c(1000, 2000, 3000)
result <- data.frame()

for (lambda in lambda_val) {
  for (ntree in ntree_val) {
    Boosting_alzh <- gbm(Diagnosis ~ ., data = ALZH.gbm[draw,], distribution = "bernoulli", n.trees = ntree, interaction.depth = 4, shrinkage = lambda)
    recall <- sum(predict(Boosting_alzh, newdata = ALZH.gbm[-draw,], n.trees = ntree, type = "response") > 0.5 & ALZH.gbm[-draw,]$Diagnosis == 1) / sum(ALZH.gbm[-draw,]$Diagnosis == 1)
    result <- rbind(result, data.frame(Lambda = lambda, NTree = ntree, Recall = recall))
  }
}

best_result <- result[which.max(result$Recall), ]
best_result
plot(result$Lambda, result$Recall, xlab = "Lambda", ylab = "Recall", type = "l", col = "blue")
points(best_result$Lambda, best_result$Recall, col = "red", pch = 19)
#plot(x=result_container$Lambda, y=result_container$Recall,xlab = "Lambda", ylab = "Recall", type = "l")
```